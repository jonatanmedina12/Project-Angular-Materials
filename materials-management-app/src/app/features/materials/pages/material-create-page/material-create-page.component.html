<p>
  material-create-page works!
</p>
<div class="material-create-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h2>
        <i nz-icon nzType="plus-circle" nzTheme="outline"></i>
        Crear Nuevo Material
      </h2>
      <p class="header-subtitle">Complete la información para registrar un nuevo material en el sistema</p>
    </div>
    
    <div class="header-actions">
      <button 
        nz-button 
        nzType="default" 
        (click)="onCancel()">
        <i nz-icon nzType="arrow-left" nzTheme="outline"></i>
        Volver
      </button>
    </div>
  </div>

  <!-- Steps -->
  <nz-card class="steps-card">
    <nz-steps [nzCurrent]="currentStep()" nzDirection="horizontal" nzSize="small">
      @for (step of steps; track $index) {
        <nz-step 
          [nzTitle]="step.title" 
          [nzDescription]="step.description"
          [nzIcon]="step.icon">
        </nz-step>
      }
    </nz-steps>
  </nz-card>

  <!-- Formulario -->
  <nz-card [nzTitle]="steps[currentStep()].title" class="form-card">
    <form nz-form [formGroup]="materialForm" (ngSubmit)="onSubmit()" class="material-form">
      
      <!-- Paso 1: Información Básica -->
      @if (currentStep() === 0) {
        <div class="form-step">
          <div class="step-description">
            <i nz-icon nzType="info-circle" nzTheme="outline"></i>
            <span>Ingrese la información básica del material</span>
          </div>
          
          <div nz-row [nzGutter]="[16, 16]">
            <!-- Nombre -->
            <div nz-col [nzSpan]="24">
              <nz-form-item>
                <nz-form-label nzRequired>Nombre del Material</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('name')">
                  <input 
                    nz-input 
                    formControlName="name"
                    placeholder="Ej: Laptop Dell Inspiron 15"
                    [class.error]="isFieldInvalid('name')" />
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Tipo -->
            <div nz-col [nzSpan]="24">
              <nz-form-item>
                <nz-form-label nzRequired>Tipo de Material</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('type')">
                  <nz-select 
                    formControlName="type"
                    nzPlaceHolder="Seleccionar tipo de material"
                    [class.error]="isFieldInvalid('type')">
                    @for (type of materialTypes; track type.value) {
                      <nz-option 
                        [nzValue]="type.value" 
                        [nzLabel]="type.label">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Descripción -->
            <div nz-col [nzSpan]="24">
              <nz-form-item>
                <nz-form-label nzRequired>Descripción</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('description')">
                  <textarea 
                    nz-input 
                    formControlName="description"
                    placeholder="Describa las características principales del material..."
                    [rows]="4"
                    [class.error]="isFieldInvalid('description')">
                  </textarea>
                  <div class="char-count">
                    {{ materialForm.get('description')?.value?.length || 0 }}/500
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </div>
      }

      <!-- Paso 2: Información Financiera -->
      @if (currentStep() === 1) {
        <div class="form-step">
          <div class="step-description">
            <i nz-icon nzType="dollar" nzTheme="outline"></i>
            <span>Configure el precio y las fechas del material</span>
          </div>
          
          <div nz-row [nzGutter]="[16, 16]">
            <!-- Precio -->
            <div nz-col [nzXs]="24" [nzSm]="12">
              <nz-form-item>
                <nz-form-label nzRequired>Precio (COP)</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('price')">
                  <nz-input-number 
                    formControlName="price"
                    [nzMin]="0.01"
                    [nzStep]="1000"
                    [nzFormatter]="priceFormatter"
                    [nzParser]="priceParser"
                    nzPlaceHolder="0.00"
                    class="full-width"
                    [class.error]="isFieldInvalid('price')">
                  </nz-input-number>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Fecha de compra -->
            <div nz-col [nzXs]="24" [nzSm]="12">
              <nz-form-item>
                <nz-form-label nzRequired>Fecha de Compra</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('purchaseDate')">
                  <nz-date-picker 
                    formControlName="purchaseDate"
                    nzPlaceHolder="Seleccionar fecha"
                    [nzFormat]="'yyyy-MM-dd'"
                    class="full-width"
                    [class.error]="isFieldInvalid('purchaseDate')">
                  </nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Fecha de venta (opcional) -->
            <div nz-col [nzSpan]="24">
              <nz-form-item>
                <nz-form-label>Fecha de Venta (Opcional)</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('saleDate')">
                  <nz-date-picker 
                    formControlName="saleDate"
                    nzPlaceHolder="Fecha de venta (dejar vacío si no aplica)"
                    [nzFormat]="'yyyy-MM-dd'"
                    class="full-width"
                    (ngModelChange)="validateDates()"
                    [class.error]="isFieldInvalid('saleDate')">
                  </nz-date-picker>
                  <div class="field-help">
                    <i nz-icon nzType="info-circle" nzTheme="outline"></i>
                    Solo complete si el material ya fue vendido
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </div>
      }

      <!-- Paso 3: Ubicación y Estado -->
      @if (currentStep() === 2) {
        <div class="form-step">
          <div class="step-description">
            <i nz-icon nzType="environment" nzTheme="outline"></i>
            <span>Seleccione la ubicación y estado del material</span>
          </div>
          
          <div nz-row [nzGutter]="[16, 16]">
            <!-- Departamento -->
            <div nz-col [nzXs]="24" [nzSm]="12">
              <nz-form-item>
                <nz-form-label nzRequired>Departamento</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('departmentCode')">
                  <nz-select 
                    formControlName="departmentCode"
                    nzPlaceHolder="Seleccionar departamento"
                    [nzLoading]="citiesLoading()"
                    (ngModelChange)="onDepartmentChange($event)"
                    [class.error]="isFieldInvalid('departmentCode')">
                    @for (dept of departments(); track dept.code) {
                      <nz-option 
                        [nzValue]="dept.code" 
                        [nzLabel]="dept.name">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Ciudad -->
            <div nz-col [nzXs]="24" [nzSm]="12">
              <nz-form-item>
                <nz-form-label nzRequired>Ciudad</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('cityCode')">
                  <nz-select 
                    formControlName="cityCode"
                    nzPlaceHolder="Seleccionar ciudad"
                    [nzLoading]="citiesLoading()"
                    [class.error]="isFieldInvalid('cityCode')">
                    @for (city of getFilteredCities(); track city.code) {
                      <nz-option 
                        [nzValue]="city.code" 
                        [nzLabel]="city.name">
                      </nz-option>
                    }
                  </nz-select>
                  @if (!materialForm.get('departmentCode')?.value) {
                    <div class="field-help">
                      <i nz-icon nzType="exclamation-circle" nzTheme="outline"></i>
                      Primero seleccione un departamento
                    </div>
                  }
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Estado -->
            <div nz-col [nzSpan]="24">
              <nz-form-item>
                <nz-form-label nzRequired>Estado del Material</nz-form-label>
                <nz-form-control [nzErrorTip]="getFieldError('status')">
                  <nz-select 
                    formControlName="status"
                    nzPlaceHolder="Seleccionar estado"
                    [class.error]="isFieldInvalid('status')">
                    @for (status of materialStatuses; track status.value) {
                      <nz-option 
                        [nzValue]="status.value" 
                        [nzLabel]="status.label">
                      </nz-option>
                    }
                  </nz-select>
                  <div class="field-help">
                    <i nz-icon nzType="info-circle" nzTheme="outline"></i>
                    El estado determina la disponibilidad del material
                  </div>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </div>
      }

      <!-- Botones de navegación -->
      <div class="form-navigation">
        <div class="nav-left">
          @if (canGoPrevious()) {
            <button 
              nz-button 
              nzType="default" 
              type="button"
              (click)="previousStep()">
              <i nz-icon nzType="left" nzTheme="outline"></i>
              Anterior
            </button>
          }
          
          <button 
            nz-button 
            nzType="default" 
            type="button"
            (click)="onReset()">
            <i nz-icon nzType="reload" nzTheme="outline"></i>
            Resetear
          </button>
        </div>
        
        <div class="nav-right">
          @if (canGoNext()) {
            <button 
              nz-button 
              nzType="primary" 
              type="button"
              (click)="nextStep()">
              Siguiente
              <i nz-icon nzType="right" nzTheme="outline"></i>
            </button>
          } @else {
            <button 
              nz-button 
              nzType="primary" 
              type="submit"
              [nzLoading]="submitting()"
              [disabled]="materialForm.invalid">
              <i nz-icon nzType="save" nzTheme="outline"></i>
              Crear Material
            </button>
          }
        </div>
      </div>
    </form>
  </nz-card>

  <!-- Resumen del formulario -->
  @if (currentStep() === steps.length - 1) {
    <nz-card nzTitle="Resumen del Material" class="summary-card">
      <div class="summary-grid">
        <div class="summary-item">
          <label>Nombre:</label>
          <span>{{ materialForm.get('name')?.value || 'No especificado' }}</span>
        </div>
        
    <div class="summary-item">
  <label>Tipo:</label>
  <span>{{ selectedMaterialType() }}</span>
</div>
        
      <div class="summary-item">
  <label>Precio:</label>
  <span>{{ formattedPrice() }}</span>
</div>

        
      <div class="summary-item">
  <label>Ciudad:</label>
  <span>{{ selectedCity() }}</span>
</div>
        
     <div class="summary-item">
  <label>Estado:</label>
  <span>{{ selectedStatus() }}</span>
</div>
        <div class="summary-item full-width">
          <label>Descripción:</label>
          <span>{{ materialForm.get('description')?.value || 'No especificada' }}</span>
        </div>
      </div>
    </nz-card>
  }

</div>