<div class="material-filters-container">
  <nz-card 
    [nzTitle]="filtersTitle" 
    [nzExtra]="filtersExtra"
    [nzBodyStyle]="{ padding: filtersExpanded() ? '20px' : '0' }">
    
    <!-- Título del card con contador -->
    <ng-template #filtersTitle>
      <div class="filters-header">
        <i nz-icon nzType="filter" nzTheme="outline"></i>
        <span>Filtros de Búsqueda</span>
        @if (hasActiveFilters()) {
          <nz-tag 
            nzColor="blue" 
            class="active-filters-count">
            Activos
          </nz-tag>
        }
      </div>
    </ng-template>

    <!-- Botón para expandir/contraer -->
    <ng-template #filtersExtra>
      <button 
        nz-button 
        nzType="text" 
        nzSize="small"
        (click)="toggleFilters()">
        <i 
          nz-icon 
          [nzType]="filtersExpanded() ? 'up' : 'down'" 
          nzTheme="outline">
        </i>
      </button>
    </ng-template>

    <!-- Formulario de filtros (colapsable) -->
    @if (filtersExpanded()) {
      <div class="filters-content">
        <form nz-form [formGroup]="filterForm" class="filters-form">
          <div nz-row [nzGutter]="[16, 16]">
            
            <!-- Filtro por tipo -->
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
              <nz-form-item>
                <nz-form-label>Tipo de Material</nz-form-label>
                <nz-form-control>
                  <nz-select 
                    formControlName="type"
                    nzPlaceHolder="Seleccionar tipo"
                    nzAllowClear
                    (keydown.enter)="onEnterKey($event)">
                    @for (type of materialTypes(); track type) {
                      <nz-option 
                        [nzValue]="type" 
                        [nzLabel]="type">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Filtro por departamento -->
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
              <nz-form-item>
                <nz-form-label>Departamento</nz-form-label>
                <nz-form-control>
                  <nz-select 
                    formControlName="departmentCode"
                    nzPlaceHolder="Seleccionar departamento"
                    nzAllowClear
                    [nzLoading]="loading()"
                    (ngModelChange)="onDepartmentChange($event)">
                    @for (dept of departments(); track dept.code) {
                      <nz-option 
                        [nzValue]="dept.code" 
                        [nzLabel]="dept.name">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Filtro por ciudad -->
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
              <nz-form-item>
                <nz-form-label>Ciudad</nz-form-label>
                <nz-form-control>
                  <nz-select 
                    formControlName="cityCode"
                    nzPlaceHolder="Seleccionar ciudad"
                    nzAllowClear
                    [nzLoading]="loading()">
                    @for (city of getFilteredCities(); track city.code) {
                      <nz-option 
                        [nzValue]="city.code" 
                        [nzLabel]="city.name">
                      </nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Filtro por fecha de compra -->
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6">
              <nz-form-item>
                <nz-form-label>Fecha de Compra</nz-form-label>
                <nz-form-control>
                  <nz-date-picker 
                    formControlName="purchaseDate"
                    nzPlaceHolder="Seleccionar fecha"
                    [nzFormat]="'yyyy-MM-dd'"
                    class="full-width">
                  </nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>

          </div>

          <!-- Botones de acción -->
          <div class="filter-actions">
            <button 
              nz-button 
              nzType="primary" 
              (click)="applyFilters()"
              [disabled]="!filterForm.valid">
              <i nz-icon nzType="search" nzTheme="outline"></i>
              Buscar
            </button>
            
            <button 
              nz-button 
              nzType="default" 
              (click)="clearFilters()"
              [disabled]="!hasActiveFilters()">
              <i nz-icon nzType="clear" nzTheme="outline"></i>
              Limpiar
            </button>
          </div>
        </form>
      </div>
    }

    <!-- Resumen de filtros activos (cuando está contraído) -->
    @if (!filtersExpanded() && hasActiveFilters()) {
      <div class="active-filters-summary">
        <span class="summary-text">Filtros activos aplicados</span>
        <button 
          nz-button 
          nzType="link" 
          nzSize="small"
          (click)="clearFilters()">
          Limpiar todos
        </button>
      </div>
    }
  </nz-card>
</div>